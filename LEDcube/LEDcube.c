/*
 * LED_test.c
 *
 * Created: 11/13/2014 7:30:55 PM
 *  Author: bisg0006
 */ 
#define F_CPU 2000000
#define SPIDlength 12
#define SPIElength 12
#define layer0 0x01
#define layer1 0x04
#define layer2 0x10
#define layer3 0x40
#define layer4 0x80
#define layer5 0x20
#define layer6 0x08
#define layer7 0x02

#include <avr/io.h>
#include <avr/interrupt.h>
#include <util/delay.h>


volatile uint8_t bob = 0x00;
volatile uint8_t muxParam = 0;
volatile uint8_t sentCounterD = 0;
volatile uint8_t sentCounterE = 0;
volatile uint8_t SPIDout[SPIDlength] = {0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00};
volatile uint8_t SPIEout[SPIElength] = {0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff};
volatile uint8_t SPIDcounter;
volatile uint8_t SPIEcounter;
volatile uint8_t Dtransmitting = 0;
volatile uint8_t Etransmitting = 0;
uint8_t slowcount = 0;
uint8_t fastcount = 0;
uint8_t layer = 0;
uint8_t layers[8] = {layer0, layer1, layer2, layer3, layer4, layer5, layer6, layer7};
/*
const uint8_t symbols[38][8][8] =	
											//0 = '0'
									{	{	{0x00,0x00,0xff,0xff,0xff,0xff,0x00,0x00},
											{0x00,0xff,0xff,0x00,0x00,0xff,0xff,0x00},
											{0xff,0xff,0x00,0x00,0x00,0x00,0xff,0xff},
											{0xff,0x00,0x00,0x00,0x00,0x00,0x00,0xff},
											{0xff,0x00,0x00,0x00,0x00,0x00,0x00,0xff},
											{0xff,0xff,0x00,0x00,0x00,0x00,0xff,0xff},
											{0x00,0xff,0xff,0x00,0x00,0xff,0xff,0x00},
											{0x00,0x00,0xff,0xff,0xff,0xff,0x00,0x00}	},
												
											//1 = '1'
										{	{0x00,0x00,0x00,0x00,0xff,0xff,0x00,0x00},
											{0x00,0x00,0x00,0xff,0xff,0xff,0x00,0x00},
											{0x00,0x00,0xff,0xff,0xff,0xff,0x00,0x00},
											{0x00,0x00,0x00,0x00,0xff,0xff,0x00,0x00},
											{0x00,0x00,0x00,0x00,0xff,0xff,0x00,0x00},
											{0x00,0x00,0x00,0x00,0xff,0xff,0x00,0x00},
											{0x00,0x00,0x00,0x00,0xff,0xff,0x00,0x00},
											{0x00,0x00,0x00,0x00,0xff,0xff,0x00,0x00}	},
												
											//2 = '2'
										{	{0x00,0x00,0x00,0xff,0xff,0x00,0x00,0x00},
											{0x00,0x00,0xff,0x00,0x00,0xff,0x00,0x00},
											{0x00,0xff,0x00,0x00,0x00,0xff,0x00,0x00},
											{0x00,0x00,0x00,0x00,0x00,0xff,0x00,0x00},
											{0x00,0x00,0x00,0x00,0xff,0x00,0x00,0x00},
											{0x00,0x00,0x00,0xff,0x00,0x00,0x00,0x00},
											{0x00,0x00,0xff,0x00,0x00,0x00,0x00,0x00},
											{0x00,0xff,0xff,0xff,0xff,0xff,0x00,0x00}	},
												
											//3 
											
											//10 = ' '
											
											//11 = 'A'		
										{	{0x00,0x00,0x00,0xff,0xff,0x00,0x00,0x00},
											{0x00,0x00,0x00,0xff,0xff,0x00,0x00,0x00},
											{0x00,0x00,0xff,0x00,0x00,0xff,0x00,0x00},
											{0x00,0x00,0xff,0x00,0x00,0xff,0x00,0x00},
											{0x00,0xff,0xff,0xff,0xff,0xff,0xff,0x00},
											{0x00,0xff,0x00,0xff,0xff,0xff,0xff,0x00},
											{0xff,0x00,0x00,0x00,0x00,0x00,0x00,0xff},
											{0xff,0x00,0x00,0x00,0x00,0x00,0x00,0xff}	},
												
										{	{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
											{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
											{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
											{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
											{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
											{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
											{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
											{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}	}	}; */
												

	//uint8_t nums[2][4] =	{	{0x66, 0x99, 0x99, 0x66},
		//						{0x66, 0x66, 0x66, 0x66}	};

uint8_t nums[2][4] =	{	{0xff, 0xff, 0xff, 0xff},
							{0xff, 0xff, 0xff, 0xff}	};
void clk_init() {
	OSC_CTRL = 0x03;	//enable 32MHz, 2MHZ RC oscillator
	//OSC_XOSCCTRL = 0x43; //XTAL 2-9MHz 256 startup
	//OSC_PLLCTRL = 0xc4;
	while(!(OSC_STATUS & 0x02)) {
		_delay_us(1);
	}
	CCP = 0xd8;
	WDT_CTRL = 0x29;
	CCP = 0xd8;
	WDT_WINCTRL = 0x29;
	CCP = 0xd8;			//enable change to CLK_CTRL.
	CLK_CTRL = 0x01;	//select 32MHz internal RC oscillator
	OSC_CTRL = 0x02;
}

void SPI_init() {
	//
	//PORTD_REMAP = 0x20;
	//
	
	PORTD_PIN3CTRL = 0x40;
	PORTE_PIN3CTRL = 0x40;
	
	TCD0_PER = 14;
	TCE0_PER = 8;
	
	PORTD_DIRSET = 0b10110000;
	PORTE_DIRSET = 0b10110000;
	
	sei();
}

void IO_init() {
	PORTD_DIRSET = 0x0f;
	PORTE_DIRSET = 0x0f;
	PORTF_DIR = 0xff;
	TCF0_CTRLA = 0x07;
	TCF0_CTRLB = 0x00;
	TCF0_PER = 255;
	TCF0_CCA = 10;
	TCF0_CCB = 10;
	TCF0_CCC = 10;
	TCF0_CCD = 10;
}

void _init() {
	PMIC_CTRL = 0x07;
	clk_init();
	SPI_init();
	IO_init();
	sei();
}

void setall(uint8_t thing) {
	for(int i = 0; i <= 11;i++) {
		SPIDout[i] = nums[slowcount][thing];
	}
	return;
}

void LEDsend(uint8_t regkey, uint8_t driverID) {
	cli();
	if(driverID == 0) {
		SPIDcounter = 1;
		TCD0_CCD = 15 - regkey;
		SPID_INTCTRL = 0x03;
		SPID_CTRL = 0b11010000;
		SPID_DATA = SPIDout[0];
		Dtransmitting = 1;
	}
	else {
		SPIEcounter = 1;
		TCE0_CCD = 15 - regkey;
		SPIE_INTCTRL = 0x03;
		SPIE_CTRL = 0b01010011;
		SPIE_DATA = SPIEout[0];
		Etransmitting = 1;
	}
	sei();
}

void LEDgain() {
	//1
	PORTD_OUT = 0x20;
	_delay_us(1);
	PORTD_OUT = 0xa0;
	_delay_us(1);
	
	//2
	PORTD_OUT = 0x20;
	_delay_us(1);
	PORTD_OUT = 0xa0;
	_delay_us(1);
	
	//3
	PORTD_OUT = 0x20;
	_delay_us(1);
	PORTD_OUT = 0xa0;
	_delay_us(1);
	
	//4
	PORTD_OUT = 0x20;
	_delay_us(1);
	PORTD_OUT = 0xa0;
	_delay_us(1);
	
	//5
	PORTD_OUT = 0x00;
	_delay_us(1);
	PORTD_OUT = 0x80;
	_delay_us(1);
	
	//6
	PORTD_OUT = 0x00;
	_delay_us(1);
	PORTD_OUT = 0x80;
	_delay_us(1);
	
	
	//7
	PORTD_OUT = 0x20;
	_delay_us(1);
	PORTD_OUT = 0xa0;
	_delay_us(1);
	
	//8
	PORTD_OUT = 0x20;
	_delay_us(1);
	PORTD_OUT = 0xa0;
	_delay_us(1);
	
	//9
	PORTD_OUT = 0x20;
	_delay_us(1);
	PORTD_OUT = 0xa0;
	_delay_us(1);
	
	//10
	PORTD_OUT = 0x20;
	_delay_us(1);
	PORTD_OUT = 0xa0;
	_delay_us(1);
	
	//11
	PORTD_OUT = 0x00;
	_delay_us(1);
	PORTD_OUT = 0x80;
	_delay_us(1);
	
	//12
	PORTD_OUT = 0x00;
	_delay_us(1);
	PORTD_OUT = 0x80;
	_delay_us(1);
	
	
	//13
	PORTD_OUT = 0x20;
	_delay_us(1);
	PORTD_OUT = 0xa0;
	_delay_us(1);
	
	//14
	PORTD_OUT = 0x20;
	_delay_us(1);
	PORTD_OUT = 0xa0;
	_delay_us(1);
	
	//15
	PORTD_OUT = 0x20;
	_delay_us(1);
	PORTD_OUT = 0xa0;
	_delay_us(1);
	
	//16
	PORTD_OUT = 0x20;
	_delay_us(1);
	PORTD_OUT = 0xa0;
	_delay_us(1);
	
	//17
	PORTD_OUT = 0x00;
	_delay_us(1);
	PORTD_OUT = 0x80;
	_delay_us(1);
	
	//18
	PORTD_OUT = 0x08;
	_delay_us(1);
	PORTD_OUT = 0x88;
	_delay_us(1);
	
	
	//19
	PORTD_OUT = 0x08;
	_delay_us(1);
	PORTD_OUT = 0x88;
	_delay_us(1);
	
	//20
	PORTD_OUT = 0x08;
	_delay_us(1);
	PORTD_OUT = 0x88;
	_delay_us(1);
	
	//21
	PORTD_OUT = 0x08;
	_delay_us(1);
	PORTD_OUT = 0x88;
	_delay_us(1);
	
	//22
	PORTD_OUT = 0x08;
	_delay_us(1);
	PORTD_OUT = 0x88;
	_delay_us(1);
	
	//23
	PORTD_OUT = 0x08;
	_delay_us(1);
	PORTD_OUT = 0x88;
	_delay_us(1);
	
	//24
	PORTD_OUT = 0x08;
	_delay_us(1);
	PORTD_OUT = 0x88;
	_delay_us(1);
}

ISR(SPID_INT_vect) {
	if(SPIDcounter == (SPIDlength - 1)) {
		PORTF_OUT = 0x00;
		TCD0_CTRLB = 0x83;
		TCD0_CTRLA = 0x01;
		TCD0_CNT = 0;
		SPID_DATA = SPIDout[SPIDcounter];
	}
	else if(SPIDcounter >= SPIDlength) {
		TCD0_CTRLA = 0x00;
		TCD0_CTRLC = 0x08;
		TCD0_CTRLB = 0x00;
		SPID_INTCTRL = 0x00;
		SPIDcounter = 0;
		Dtransmitting = 0;
		PORTF_OUT = layers[layer];
	}
	else{ 
		SPID_DATA = SPIDout[SPIDcounter];
	}
	SPIDcounter++;
}

ISR(SPIE_INT_vect) {
	if(SPIEcounter == (SPIElength - 1)) {
		TCE0_CTRLB = 0x83;
		TCE0_CTRLA = 0x05;
		TCE0_CNT = 0;
		SPIE_DATA = SPIEout[SPIEcounter];
	}
	else if(SPIDcounter >= SPIElength) {
		TCE0_CTRLA = 0x00;
		TCE0_CTRLC = 0x08;
		TCE0_CTRLB = 0x00;
		SPIE_INTCTRL = 0x00;
		SPIEcounter = 0;
		Etransmitting = 0;
	}
	else{
		SPIE_DATA = SPIEout[SPIEcounter];
	}
	SPIEcounter++;
}

void layerwrite(uint8_t layer, uint8_t row0, uint8_t row1, uint8_t row2, uint8_t row3, uint8_t row4, uint8_t row5, uint8_t row6, uint8_t row7) {
	SPIDout[0] = row0;
	SPIEout[0] = row4;
	SPIDout[3] = row1;
	SPIDout[6] = row2;
	SPIDout[9] = row3;
	SPIEout[3] = row5;
	SPIEout[6] = row6;
	SPIEout[9] = row7;
	
	LEDsend(1,0);
	LEDsend(1,1);
	
	char layerOut = 0x01 << (layer - 1);
	
	PORTF_OUT = 0x00;
	
	_delay_ms(10);
	PORTF_OUT = layerOut;
}

void symblayer(uint8_t L0, uint8_t L1, uint8_t L2, uint8_t L3, uint8_t L4, uint8_t L5, uint8_t L6, uint8_t L7) {
	
} 

void simplechar(uint8_t thing) {
	for(int i = 0; i <= 11;i++) {
	SPIDout[i] = nums[slowcount][thing];
	}
	return;
}

void cubewrite() {
	layerwrite(0, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff);
	_delay_ms(10);
	layerwrite(1, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff);
	_delay_ms(10);
	layerwrite(2, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff);
	_delay_ms(10);
	layerwrite(3, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff);
	_delay_ms(10);
	layerwrite(4, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff);
	_delay_ms(10);
	layerwrite(5, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff);
	_delay_ms(10);
	layerwrite(6, 0x00, 0xff, 0xff, 0x00, 0xff, 0xff, 0xff, 0x00);
	_delay_ms(10);
	layerwrite(7, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0x00, 0x00);
	_delay_ms(10);
}

int main(void)
{	
	_init();
	SPIDout[0] = 0x07;
	SPIDout[1] = 0x00;
	SPIDout[2] = 0x00;
	SPIDout[3] = 0x07;
	SPIDout[4] = 0x00;
	SPIDout[5] = 0x00;
	SPIDout[6] = 0x07;
	SPIDout[7] = 0x00;
	SPIDout[8] = 0x00;
	SPIDout[9] = 0x07;
	SPIDout[10] = 0x00;
	SPIDout[11] = 0x00;
	LEDsend(8,0);
	_delay_ms(10);
	
	SPIDout[0] = 0xff;
	SPIDout[1] = 0xff;
	SPIDout[2] = 0x03;
	SPIDout[3] = 0xff;
	SPIDout[4] = 0xff;
	SPIDout[5] = 0x03;
	SPIDout[6] = 0xff;
	SPIDout[7] = 0xff;
	SPIDout[8] = 0x03;
	SPIDout[9] = 0xff;
	SPIDout[10] = 0xff;
	SPIDout[11] = 0x03;
	LEDsend(15,0);
	_delay_ms(10);
    while(1)
    {	layer = 0;
		setall(0);
		LEDsend(1,0);
		_delay_ms(1);
		
		layer = 1;
		setall(1);
		LEDsend(1,0);
		_delay_us(100);
		layer = 2;
		setall(2);
		LEDsend(1,0);
		
		_delay_ms(1);
		layer = 3;
		setall(3);
		LEDsend(1,0);
		
		_delay_ms(1);
layer = 4;
		setall(0);
		LEDsend(1,0);
		
		_delay_ms(1);
		layer = 5;
		setall(1);
		LEDsend(1,0);
		_delay_ms(1);
		layer = 6;		
		setall(2);
		LEDsend(1,0);
		_delay_ms(1);
		layer = 7;		
		setall(3);
		LEDsend(1,0);

		_delay_ms(1);
		
		fastcount++;
		if(fastcount >=255) slowcount++;
		if(slowcount >1) slowcount = 0; 
    }
}
